{% extends "base.html" %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Police Technology Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        :root {
            --primary-pink: #ff6bb4;
            --secondary-pink: #ff8cc3;
            --light-pink: #ffcce6;
            --dark-pink: #d94d8c;
            --text-pink: #ffe6f2;
            --accent-purple: #d8b4ff;
            --accent-blue: #b4e0ff;
        }
                /* ===== COMMON STYLES ===== */
                body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: var(--text-pink);
            overflow-x: hidden;
            position: relative;
            background: 
                linear-gradient(transparent 95%, rgba(255, 105, 180, 0.1) 96%),
                linear-gradient(90deg, transparent 95%, rgba(255, 105, 180, 0.1) 96%);
            background-size: 20px 20px;
            background-color: var(--dark-bg);
            transition: all 0.5s ease;
        }

        /* Soft mode colors */
        .soft-mode {
            --primary-pink: #ff9ac8;
            --secondary-pink: #ffb3d6;
            --light-pink: #ffe6f2;
            --dark-pink: #e673a5;
            --text-pink: #91235c;
            --dark-bg: #d7709f;
            --neon-blue: #66ccff;
            --accent-purple: #cc99ff;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: var(--text-pink);
            overflow-x: hidden;
            position: relative;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            position: relative;
        }

        /* 8-bit pixel border effect */
        .pixel-border {
            position: relative;
            border: 4px solid var(--primary-pink);
            border-image: linear-gradient(45deg, var(--primary-pink), var(--accent-purple), var(--accent-blue), var(--primary-pink)) 1;
            animation: borderPulse 4s linear infinite;
            box-shadow: 0 0 15px rgba(255, 105, 180, 0.5), inset 0 0 15px rgba(255, 105, 180, 0.3);
        }

        @keyframes borderPulse {
            0% {
                border-image-source: linear-gradient(45deg, var(--primary-pink), var(--accent-purple), var(--accent-blue), var(--primary-pink));
            }

            25% {
                border-image-source: linear-gradient(45deg, var(--accent-purple), var(--accent-blue), var(--primary-pink), var(--accent-purple));
            }

            50% {
                border-image-source: linear-gradient(45deg, var(--accent-blue), var(--primary-pink), var(--accent-purple), var(--accent-blue));
            }

            75% {
                border-image-source: linear-gradient(45deg, var(--primary-pink), var(--accent-purple), var(--accent-blue), var(--primary-pink));
            }

            100% {
                border-image-source: linear-gradient(45deg, var(--accent-purple), var(--accent-blue), var(--primary-pink), var(--accent-purple));
            }
        }

        .about-section {
            background: rgba(219, 77, 140, 0.8);
            border-radius: 0;
            padding: 25px;
            margin: 30px 0;
            position: relative;
            overflow: hidden;
        }

        .about-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-pink), var(--accent-purple), var(--accent-blue), var(--primary-pink));
            animation: gradientMove 3s linear infinite;
        }

        @keyframes gradientMove {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 100% 50%;
            }
        }

        .about-section h1,
        .about-section h2 {
            color: var(--text-pink);
            font-family: 'Press Start 2P', cursive;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 3px 3px 0px var(--dark-pink);
            font-size: 1.8rem;
            letter-spacing: 2px;
        }

        .about-section p {
            font-size: 1rem;
            line-height: 1.7;
            margin-bottom: 15px;
            color: var(--text-pink);
        }

        .citation-container {
            background: rgba(255, 204, 230, 0.2);
            padding: 1.5rem;
            border-radius: 0;
            margin: 20px 0;
            border-left: 6px solid var(--accent-purple);
            position: relative;
        }

        .citation-container::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
        }

        .citation-container blockquote {
            margin: 0;
            padding: 0;
            font-style: italic;
            color: var(--text-pink);
            font-size: 0.95rem;
        }

        .citation-container cite {
            display: block;
            text-align: right;
            font-style: normal;
            color: var(--accent-blue);
            margin-top: 10px;
            font-family: 'DotGothic16', sans-serif;
        }

        /* Flower cursor trail */
        .flower-trail {
            position: fixed;
            width: 24px;
            height: 24px;
            pointer-events: none;
            z-index: 9999;
            opacity: 0;
            transform: translate(-50%, -50%);
            transition: opacity 0.3s, transform 0.2s;
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.2));
        }

        .navbar {
            background-color: rgba(0, 0, 0, 0.8);
            padding: 1rem;
            margin-bottom: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            border-bottom: 3px solid var(--primary-pink);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            transition: all 0.5s ease;
        }

        .navbar a {
            color: var(--text-pink);
            text-decoration: none;
            margin: 0 1rem;
            font-weight: 600;
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 0;
            transition: all 0.3s;
            font-family: 'DotGothic16', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }

        .navbar a:hover {
            color: var(--neon-blue);
            text-shadow: 0 0 5px var(--accent-purple);
        }

        .navbar a::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--accent-purple);
            transition: width 0.3s;
        }

        .navbar a:hover::after {
            width: 100%;
        }

        .navbar a.active {
            color: var(--neon-blue);
            text-shadow: 0 0 5px var(--accent-purple);
        }

        .navbar a.active::after {
            width: 100%;
        }

        .navbar a[href="./data.html"] {
            position: relative;
        }

        .navbar a[href="./data.html"]:hover {
            color: #b4e0ff;
            text-shadow: 0 0 8px #ff6bb4;
        }

        .navbar a[href="./data.html"]::after {
            content: "NEW!";
            position: absolute;
            top: -10px;
            right: -15px;
            font-size: 0.6rem;
            background: #ff6bb4;
            color: black;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Press Start 2P';
        }

        h1 {
            color: var(--text-pink);
            text-align: center;
            margin-bottom: 2rem;
            font-family: 'Press Start 2P', cursive;
            text-shadow: 4px 4px 0px var(--dark-pink);
            font-size: 2rem;
        }

        .data-table {
            background: rgba(219, 77, 140, 0.8);
            border-radius: 0;
            padding: 20px;
            margin-bottom: 2rem;
            overflow-x: auto;
            border: 3px solid var(--accent-purple);
        }

        .table-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            padding: 1rem;
            border-bottom: 2px dotted var(--accent-blue);
            align-items: center;
            color: var(--text-pink);
            font-family: 'DotGothic16', sans-serif;
        }

        .table-header {
            font-weight: 600;
            background-color: rgba(255, 107, 180, 0.5);
            border-radius: 0;
            position: sticky;
            top: 0;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-pink);
            border-bottom: 3px solid var(--accent-blue);
        }

        #map {
            height: 600px;
            border-radius: 0;
            margin: 2rem 0;
            border: 3px solid var(--primary-pink);
            box-shadow: 0 0 20px rgba(255, 107, 180, 0.3);
        }

        .popup-content {
            font-family: 'DotGothic16', sans-serif;
            min-width: 250px;
            background: rgba(219, 77, 140, 0.9);
            padding: 1rem;
            color: var(--text-pink);
            border: 2px solid var(--accent-purple);
        }

        .popup-content h3 {
            color: var(--accent-blue);
            margin-top: 0;
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            text-shadow: 2px 2px 0px var(--dark-pink);
        }

        .popup-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 600;
            display: inline-block;
            margin-top: 0.5rem;
            border-bottom: 1px dotted var(--accent-blue);
            transition: all 0.3s;
        }

        .popup-link:hover {
            color: var(--text-pink);
            text-shadow: 0 0 5px var(--accent-blue);
            border-bottom: 1px solid var(--accent-blue);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: var(--accent-blue);
            font-family: 'Press Start 2P', cursive;
        }



        #file-info {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--accent-blue);
            font-family: 'DotGothic16', sans-serif;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin: 1rem 0;
            gap: 0.5rem;
        }

        .pagination button {
            background-color: var(--primary-pink);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            box-shadow: 3px 3px 0px var(--dark-pink);
            transition: all 0.3s;
        }

        .pagination button:hover {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px var(--dark-pink);
        }

        .pagination button:disabled {
            background-color: var(--dark-pink);
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: 3px 3px 0px var(--dark-pink);
        }

        .pagination-info {
            text-align: center;
            margin: 1rem 0;
            color: var(--accent-blue);
            font-weight: 600;
            font-family: 'DotGothic16', sans-serif;
        }

        /* Updated image container styles */
        .image-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            height: 0;
            overflow: hidden;
            transition: height 0.5s ease;
        }

        #cute-image {
            max-width: 200px;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.5s ease 0.2s;
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.3);
            z-index: 2;
            position: relative;
            border: 4px solid var(--accent-purple);
            image-rendering: pixelated;
        }

        .image-container.active {
            height: 220px;
        }

        .image-container.active #cute-image {
            opacity: 1;
            transform: scale(1);
        }

        .bubble-effect {
            position: absolute;
            width: 180px;
            height: 180px;
            background-color: rgba(255, 182, 193, 0.3);
            border-radius: 50%;
            z-index: 1;
            animation: bubblePulse 3s infinite ease-in-out;
        }

        @keyframes bubblePulse {
            0% {
                transform: scale(0.95);
                opacity: 0.7;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }

            100% {
                transform: scale(0.95);
                opacity: 0.7;
            }
        }

        /* 8-bit grid overlay */
        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 182, 193, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 182, 193, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: 9998;
        }


        /* Retro scanlines effect */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(
                    rgba(0, 0, 0, 0) 50%, 
                    rgba(0, 0, 0, 0.2) 50%
                );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 9997;
            animation: scanline 8s linear infinite;
        }

        /* Pixel animation */
        .pixel-animation {
            animation: pixelate 0.5s infinite;
        }

        /* Toggle button style */
        .toggle-animation {
            position: fixed;
            top: 11px;
            left:1125px;
            z-index: 10000;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            border: 2px solid #ff6bb4;
            border-radius: 5px;
        }

        

        .toggle-animation:hover {
            background-color: rgba(255, 107, 180, 0.7);
            color: #000;
            text-shadow: 0 0 5px #fff;
        }

        /* Keyframe animations */
        @keyframes scanline {
            0% { background-position: 0 0; }
            100% { background-position: 0 100%; }
        }

        @keyframes pixelate {
            0% { filter: blur(0px); }
            50% { filter: blur(1px); }
            100% { filter: blur(0px); }
        }

        /* Disabled state */
        .effects-disabled .scanlines {
            display: none !important; /* Completely hides scanlines */
        }

        .effects-disabled .pixel-animation {
            animation: none !important;
            filter: none !important;
        }

        .effects-disabled #retroToggle {
            background-color: rgba(255, 107, 180, 0.7);
            color: #000;
        }
        .effects-disabled .pixel-animation {
            animation: none !important;
        }

        .effects-disabled #retroToggle {
            background-color: rgba(255, 107, 180, 0.7);
            color: #000;
        }



        @media (max-width: 768px) {
            .table-row {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
                gap: 0.5rem;
            }
            
            .navbar a {
                margin: 0 0.5rem;
                padding: 0.5rem;
                font-size: 0.8rem;
            }

            .about-section h1 {
                font-size: 1.4rem;
            }

            h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="grid-overlay"></div>
    <div class="scanlines"></div>
    <button id="retroToggle" class="toggle-animation">DISABLE EFFECTS</button>

    <div class="content-wrapper">
        <nav class="navbar">
            <div class="container">
                <a href="/#table">Data Table</a>
                <a href="/#map">Interactive Map</a>
                <a href="/data.html" >Data Wars</a>
            </div>
        </nav>
        <div class="about-section pixel-border">
            <h1>Police Tech Atlas</h1>
            <p>
                Welcome to the Police Tech Atlas, an interactive resource that sheds light on the growing field of law enforcement and surveillance technology in the US. You can see and comprehend the expanding technological footprint of policing in communities across the country with our tool.
            </p>
            <p>
              Through our vibrant, accessible interface, you can track the deployment of facial recognition systems, automated license plate readers, drones, body-worn cameras, predictive policing software, and other emerging surveillance technologies. Explore how these tools are distributed geographically and identify patterns that might otherwise remain hidden.
            </p>
            
            <div class="citation-container">
              <blockquote>
                "The spread of surveillance technologies poses enormous challenges to traditional conceptions of privacy, civil liberties, and human rights. Only through creating knowledge, transparency, and greater public awareness can communities effectively advocate for appropriate constraints on the use of surveillance technology."
              </blockquote>
              <cite>Atlas of Surveillance, Electronic Frontier Foundation</cite>
            </div>

            <h1>Police Technology Tracker</h1>
            
            <!-- Add file upload button -->
            <div class="file-upload">

                <input type="file" id="file-input" accept=".csv" style="display: none;">
                <div id="file-info"></div>
            </div>
            
            <div id="loading" class="loading" style="display: none;">Loading data...</div>

            <div id="table-section">
                <div id="table" class="data-table pixel-border">
                    <div class="table-row table-header">
                        <div>City</div>
                        <div>State</div>
                        <div>Agency</div>
                        <div>Technology</div>
                        <div>Vendor</div>
                    </div>
                </div>

                <div class="pagination-info">
                    Showing <span id="start-item">0</span>-<span id="end-item">0</span> of <span id="total-items">0</span> entries
                </div>

                <div class="pagination">
                    <button id="prev-page" disabled>Previous</button>
                    <button id="next-page" disabled>Next</button>
                </div>
            </div>

            <div id="map" class="pixel-border"></div>
        </div>
        {% include "footer.html" %}
    </div>

    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="flower" viewBox="0 0 100 100">
            <path d="M50 20a5 5 0 0 1 5 5v20a5 5 0 0 1-10 0V25a5 5 0 0 1 5-5z" fill="#ff69b4"/>
            <path d="M50 80a5 5 0 0 1 5-5h20a5 5 0 0 1 0 10H55a5 5 0 0 1-5-5z" fill="#ff69b4"/>
            <path d="M20 50a5 5 0 0 1 5-5h20a5 5 0 0 1 0 10H25a5 5 0 0 1-5-5z" fill="#ff69b4"/>
            <path d="M80 50a5 5 0 0 1-5 5H55a5 5 0 0 1 0-10h20a5 5 0 0 1 5 5z" fill="#ff69b4"/>
            <circle cx="50" cy="50" r="15" fill="#ffb6c1"/>
        </symbol>
    </svg>

    <!-- Add Leaflet.heat script -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        // ===== FLOWER CURSOR TRAIL =====
        const flowers = [];
        const flowerCount = 12;
        const flowerColors = ['#ff69b4', '#ffb6c1', '#db7093', '#ff85a2', '#ff9ebb'];
        const flowerSizes = [18, 20, 22, 24, 26];
    
        // Create flower elements
        for (let i = 0; i < flowerCount; i++) {
            const flower = document.createElement('div');
            flower.className = 'flower-trail';
            const size = flowerSizes[Math.floor(Math.random() * flowerSizes.length)];
            const color = flowerColors[Math.floor(Math.random() * flowerColors.length)];
    
            flower.innerHTML = `
                <svg width="${size}" height="${size}" style="color: ${color}">
                    <use href="#flower"></use>
                </svg>
            `;
    
            flower.style.opacity = 0;
            flower.style.transition = `opacity ${0.2 + i*0.05}s, transform ${0.2 + i*0.03}s`;
            document.body.appendChild(flower);
            flowers.push({
                element: flower,
                size: size,
                delay: i * 50
            });
        }
    
        let mouseX = 0;
        let mouseY = 0;
        let lastPositions = [];
        const positionHistoryLength = 5;
    
        // Track mouse movement
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
    
            // Store recent positions for smoother trail
            lastPositions.unshift({x: mouseX, y: mouseY});
            if (lastPositions.length > positionHistoryLength) {
                lastPositions.pop();
            }
    
            updateFlowerTrail();
        });
    
        function updateFlowerTrail() {
            flowers.forEach((flower, index) => {
                const posIndex = Math.min(index, lastPositions.length - 1);
                if (posIndex >= 0) {
                    const {x, y} = lastPositions[posIndex];
    
                    // Calculate delay-based movement
                    setTimeout(() => {
                        flower.element.style.left = `${x}px`;
                        flower.element.style.top = `${y}px`;
                        flower.element.style.opacity = 0.8 - (index * 0.06);
                        flower.element.style.transform = `
                            translate(-50%, -50%)
                            rotate(${index * 15}deg)
                            scale(${0.7 + (index * 0.03)})
                        `;
                    }, flower.delay);
                }
            });
        }
    
        // Hide flowers when mouse stops
        let mouseStopTimer;
        document.addEventListener('mousemove', () => {
            clearTimeout(mouseStopTimer);
            flowers.forEach(flower => {
                flower.element.style.opacity = 0.8;
            });
            mouseStopTimer = setTimeout(() => {
                flowers.forEach(flower => {
                    flower.element.style.opacity = 0;
                });
            }, 300);
        });

        // ===== APPLICATION CODE =====
        const ITEMS_PER_PAGE = 50;
        let currentPage = 1;
        let allData = [];
        let markersCluster = null;
        let heatLayer = null;
        let isLoading = false;

        // Initialize map
        const map = L.map('map').setView([37.8, -96], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Initialize marker cluster group
        markersCluster = L.markerClusterGroup({
            maxClusterRadius: 80,
            disableClusteringAtZoom: 12,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            chunkedLoading: true,
            chunkProgress: updateLoadingInfo
        });
        map.addLayer(markersCluster);

        // Function to update loading information
        function updateLoadingInfo(processed, total) {
            const loadingElement = document.getElementById('loading');
            if (isLoading) {
                loadingElement.textContent = `Processing markers: ${processed}/${total}`;
            }
        }

// Function to load CSV data
function loadCSVData() {
    const loadingElement = document.getElementById('loading');
    loadingElement.style.display = 'block';
    isLoading = true;

    // First load coordinates data
    Papa.parse('/static/deployments_with_coords.csv', {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(coordsResults) {
            // Now load the additional data file with vendor and technology info
            Papa.parse('/static/data/cleaned_data/cleaned_atlas.csv', {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(cleanedResults) {
                    // Create a lookup map from cleaned_atlas data
                    const dataMap = {};
                    cleanedResults.data.forEach(item => {
                        // Create a unique key based on agency name or other identifiers
                        const key = `${item.Agency}-${item.City}-${item.State}`.toLowerCase();
                        dataMap[key] = {
                            vendor: item.Vendor,
                            technology: item.tech_type
                        };
                    });
                    
                    // Process the coordinates data and merge with cleaned data
                    allData = coordsResults.data.map(item => {
                        // Create the same key for matching
                        const lookupKey = `${item.Agency}-${item.City}-${item.State}`.toLowerCase();
                        const additionalData = dataMap[lookupKey] || {};
                        
                        return {
                            city: item.City,
                            state: item.State,
                            agency: item.Agency,
                            technology: additionalData.technology || item.tech_type,
                            vendor: additionalData.vendor || item.Vendor,
                            summary: item.Summary,
                            link: item.Link,
                            lat: parseFloat(item.Latitude),
                            lng: parseFloat(item.Longitude)
                        };
                    }).filter(item => !isNaN(item.lat) && !isNaN(item.lng));

                    document.getElementById('total-items').textContent = allData.length;
                    loadingElement.style.display = 'none';
                    currentPage = 1;
                    isLoading = false;

                    // Create heatmap from all data
                    updateHeatmap();

                    // Update table and pagination
                    updateTable();
                    updatePaginationControls();

                    // Add markers to map
                    addMarkersToMap();
                },
                error: function(error) {
                    console.error('Error loading cleaned data:', error);
                    loadingElement.textContent = 'Error loading additional data. Please try again.';
                    isLoading = false;
                }
            });
        },
        error: function(error) {
            console.error('Error loading coordinates CSV:', error);
            loadingElement.textContent = 'Error loading data. Please try again.';
            isLoading = false;
        }
    });
}

        // Function to add markers to the map
        function addMarkersToMap() {
            markersCluster.clearLayers();
            
            allData.forEach(item => {
                if (item.lat && item.lng) {
                    const marker = L.marker([item.lat, item.lng]);
                    marker.bindPopup(`
                        <div class="popup-content">
                            <h3>${item.agency}</h3>
                            <p><strong>Location:</strong> ${item.city}, ${item.state}</p>
                            <p><strong>Technology:</strong> ${item.technology}</p>
                            <p><strong>Vendor:</strong> ${item.vendor}</p>
                            ${item.summary ? `<p>${item.summary}</p>` : ''}
                            ${item.link ? `<a href="${item.link}" target="_blank" class="popup-link">More Info</a>` : ''}
                        </div>
                    `);
                    markersCluster.addLayer(marker);
                }
            });
        }

        // Function to update heatmap
        function updateHeatmap() {
            // Remove heat layer if exists
            if (heatLayer) {
                map.removeLayer(heatLayer);
            }

            // Create heatmap points from all data
            const heatPoints = allData
                .filter(item => item.lat && item.lng)
                .map(item => [item.lat, item.lng, 0.5]);

            heatLayer = L.heatLayer(heatPoints, {
                radius: 25,
                blur: 15,
                maxZoom: 12,
                gradient: {
                    0.4: 'blue',
                    0.6: 'cyan',
                    0.7: 'lime',
                    0.8: 'yellow',
                    1.0: 'red'
                }
            }).addTo(map);
        }

        // Function to update table
        function updateTable() {
            const table = document.getElementById('table');
            const startIdx = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIdx = startIdx + ITEMS_PER_PAGE;
            const pageData = allData.slice(startIdx, endIdx);

            // Clear existing rows (except header)
            const rows = document.querySelectorAll('.table-row:not(.table-header)');
            rows.forEach(row => row.remove());

            // Add new rows
            pageData.forEach(item => {
                const row = document.createElement('div');
                row.className = 'table-row';
                row.innerHTML = `
                    <div>${item.city || 'N/A'}</div>
                    <div>${item.state || 'N/A'}</div>
                    <div>${item.agency || 'N/A'}</div>
                    <div>${item.technology || 'N/A'}</div>
                    <div>${item.vendor || 'N/A'}</div>
                `;

                // Add click handler to highlight on map
                row.addEventListener('click', () => {
                    if (item.lat && item.lng) {
                        map.setView([item.lat, item.lng], 12);
                    }
                });

                table.appendChild(row);
            });

            // Update pagination info
            document.getElementById('start-item').textContent = startIdx + 1;
            document.getElementById('end-item').textContent = Math.min(endIdx, allData.length);
        }

        // Function to update pagination controls
        function updatePaginationControls() {
            const totalPages = Math.ceil(allData.length / ITEMS_PER_PAGE);
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        // Pagination event listeners
        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
                updatePaginationControls();
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            const totalPages = Math.ceil(allData.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                updateTable();
                updatePaginationControls();
            }
        });

        // Load data when the page loads
        document.addEventListener('DOMContentLoaded', loadCSVData);
        document.addEventListener('DOMContentLoaded', function() {
            const toggleButton = document.getElementById('retroToggle');
            const body = document.body;
            
            // Check for saved preference
            if (localStorage.getItem('retroEffectsDisabled') === 'true') {
                body.classList.add('effects-disabled');
                toggleButton.textContent = 'ENABLE EFFECTS';
            }
            
            toggleButton.addEventListener('click', function() {
                const isDisabled = !body.classList.contains('effects-disabled');
                
                body.classList.toggle('effects-disabled');
                toggleButton.textContent = isDisabled ? 'ENABLE EFFECTS' : 'DISABLE EFFECTS';
                localStorage.setItem('retroEffectsDisabled', isDisabled);
            });
        });


        
    </script>
</body>

</html>
{% endblock %}